<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <!-- ìºì‹œ ë°©ì§€ -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <!-- âœ… ì ‘ìˆ˜ ì‹œê°„ ê°€ë“œ(í•„ìš” ì‹œ) -->
  <script src="/open.js"></script>

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì‹ ì²­ í¼</title>
  <style>
    :root { color-scheme: light dark; }
    body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; }
    .wrap { max-width:760px; margin:40px auto; padding:0 20px; }
    h2 { font-size:26px; margin:22px 0 14px; }
    .block { margin:18px 0; }
    label { display:block; margin-bottom:8px; font-weight:700; }
    input[type=text], input[type=date], input[type=tel], select {
      width: 360px; max-width: 100%; padding:10px 12px; border:1px solid #cfd4dc; border-radius:6px; font-size:16px;
    }
    input[type=checkbox]{ width:18px; height:18px; vertical-align:middle; }
    .check-row{ margin:8px 0; font-weight:600; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    button { padding:10px 14px; border-radius:8px; border:1px solid #cfd4dc; background:#111827; color:#fff; cursor:pointer; }
    small { color:#6b7280; }

    /* ğŸ“Œ ì£¼ì†Œ ê²€ìƒ‰ ë ˆì´ì–´: í™”ë©´ ì¤‘ì•™ ê³ ì • + ë·°í¬íŠ¸ í•œê³„ ë‚´ í¬ê¸° */
    #addrWrap{
      position: fixed;
      inset: 50% auto auto 50%;
      transform: translate(-50%, -50%);
      width: min(520px, 96vw);
      height: min(640px, 90vh);
      z-index: 99999;
      display: none;            /* ì—´ ë•Œë§Œ í‘œì‹œ */
      background: #fff;
      box-shadow: 0 10px 40px rgba(0,0,0,.3);
      overflow: hidden;         /* ë‚´ë¶€ ìŠ¤í¬ë¡¤ì€ iframeì´ ë‹´ë‹¹ */
    }
    #addrWrap iframe{ width:100%; height:100%; border:0; }
    #addrClose {
      position:absolute; top:-40px; right:0;
      background:#333; color:#fff; border:none; padding:6px 12px;
      cursor:pointer; border-radius:4px;
    }
  </style>
</head>
<body>
  <!-- ì˜ˆì‹œ: ìµœìƒë‹¨ ì¶”ê°€ ì²´í¬ -->

  <div class="wrap">
    <!-- Step 1. ì§€ì  -->
    <h2>Step 1. ì§€ì  ì„ íƒ</h2>
    <div class="block">
      <label for="branch">ì§€ì </label>
      <select id="branch" required>
        <option value="">ì„ íƒ</option>
        <option>ê°œí¬</option>
        <option>ì„œì´ˆ</option>
        <option>ì••êµ¬ì •</option>
        <option>í•œë‚¨</option>
      </select>
    </div>

    <!-- Step 2. ë™ì˜ -->
    <h2>Step 2. ë™ì˜</h2>
    <div class="block">
      <div class="check-row"><label><input id="agreeRules" type="checkbox" required> ëª¨ì§‘ ê·œì •ì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤.</label></div>
      <div class="check-row"><label><input id="agreePrivacy" type="checkbox" required> ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë™ì˜í•©ë‹ˆë‹¤.</label></div>
      <div class="check-row"><label><input id="agreeNotice" type="checkbox" required> ìœ ì˜ ì‚¬í•­ì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤.</label></div>
    </div>

    <!-- Step 3. ì•„ì´/ë³´í˜¸ì -->
    <h2>Step 3. ì•„ì´/ë³´í˜¸ì ì •ë³´</h2>

    <div class="block">
      <label for="childBirth">ì•„ì´ ìƒë…„ì›”ì¼</label>
      <input id="childBirth" type="text" placeholder="2023/01/01" required>
    </div>
    
    <div class="block">
      <label for="childName">ì•„ì´ ì´ë¦„</label>
      <input id="childName" type="text" placeholder="ì´ë¦„ ì…ë ¥" required>
    </div>
    <div class="block">
      <label for="gender">ì„±ë³„</label>
      <select id="gender" required>
        <option value="">ì„ íƒ</option>
        <option>ë‚¨</option>
        <option>ì—¬</option>
      </select>
    </div>
    <div class="block">
      <label for="parentName">ë³´í˜¸ì ì„±ëª…</label>
      <input id="parentName" type="text" required>
    </div>
    <div class="block">
      <label for="relation">ì‹ ì²­ í•™ìƒê³¼ì˜ ê´€ê³„</label>
      <select id="relation" required>
        <option value="">ì„ íƒ</option>
        <option>ëª¨</option>
        <option>ë¶€</option>
        <option>ê¸°íƒ€</option>
      </select>
    </div>

    <!-- ì¤‘ê°„ì— ì„ì˜ ì²´í¬ ì¶”ê°€(ì˜ˆì‹œ) -->
    <div class="check-row"><label><input id="agreePrivacy1" type="checkbox" required> ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë™ì˜í•©ë‹ˆë‹¤1.</label></div>

    <div class="block">
      <label for="parentPhone">ë³´í˜¸ì íœ´ëŒ€í°ë²ˆí˜¸</label>
      <input id="parentPhone" type="tel" inputmode="numeric" pattern="[0-9\-]*" placeholder="010-1234-5678" required>
    </div>

    <div class="check-row"><label><input id="agreePrivacy2" type="checkbox" required> ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë™ì˜í•©ë‹ˆë‹¤2.</label></div>

    <!-- Step 4. ì£¼ì†Œ -->
    <h2>Step 4. ì£¼ì†Œ</h2>
    <div class="block">
      <label>ì£¼ì†Œ</label>
      <div class="row">
        <input id="addrBase" type="text" placeholder="ê¸°ë³¸ì£¼ì†Œ" style="width:420px;" required>
        <button id="btnAddrSearch" type="button">ì£¼ì†Œ ê²€ìƒ‰</button>
      </div>
      <div class="row" style="margin-top:8px">
        <input id="addrDetail" type="text" placeholder="ìƒì„¸ì£¼ì†Œ ì…ë ¥" style="width:420px;" required>
      </div>
    </div>

    <!-- ìµœì¢… ë™ì˜ -->
    <div class="block">
      <label><input id="confirmNotice" type="checkbox" required> ìœ ì˜ ì‚¬í•­ì„ ìµœì¢…ì ìœ¼ë¡œ í™•ì¸í–ˆìŠµë‹ˆë‹¤.</label>
    </div>

    <!-- ì œì¶œ -->
    <div class="block">
      <button id="btnSubmit" type="button">ì‹ ì²­í•˜ê¸°</button>
    </div>
  </div>

  <!-- ì£¼ì†Œê²€ìƒ‰ ë ˆì´ì–´ -->
  <div id="addrWrap"><button id="addrClose" type="button">ë‹«ê¸° âœ•</button></div>

  <!-- ì¹´ì¹´ì˜¤ ìš°í¸ë²ˆí˜¸ -->
  <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js" defer></script>
  <script>
    // ===== ì£¼ì†Œ embed =====
    const addrWrap   = document.getElementById('addrWrap');
    const addrBase   = document.getElementById('addrBase');
    const addrDetail = document.getElementById('addrDetail');

    // ì—´ê¸°
    document.getElementById('btnAddrSearch').addEventListener('click', () => {
      // ê¸°ì¡´ iframe ì •ë¦¬(ì¤‘ë³µ ë°©ì§€)
      addrWrap.innerHTML = '<button id="addrClose" type="button">ë‹«ê¸° âœ•</button>';
      addrWrap.style.display = 'block';
      addrWrap.style.zIndex  = '99999';
      addrWrap.style.width   = 'min(520px, 96vw)';
      addrWrap.style.height  = 'min(640px, 90vh)';
      document.body.style.overflow = 'hidden'; // ë°°ê²½ ìŠ¤í¬ë¡¤ ì ê¸ˆ

      new daum.Postcode({
        oncomplete: function(data) {
          const base = data.roadAddress || data.jibunAddress || "";
          addrBase.value = base;
          addrDetail.focus();

          // ë‹«ê¸°
          addrWrap.style.display = 'none';
          document.body.style.overflow = '';
          addrWrap.innerHTML = '<button id="addrClose" type="button">ë‹«ê¸° âœ•</button>';
        },
        onresize: function(size) {
          const h = Math.min(size.height || 640, Math.floor(window.innerHeight * 0.9));
          addrWrap.style.height = h + 'px';
        },
        width: '100%',
        height: '100%'
      }).embed(addrWrap);

      // í¬ì»¤ìŠ¤ ìœ ë„(ê°€ëŠ¥í•œ ê²½ìš°)
      setTimeout(() => {
        try {
          const ifr = addrWrap.querySelector('iframe');
          if (ifr && ifr.contentWindow) ifr.contentWindow.focus();
        } catch(_) {}
      }, 50);
    });

    // ë‹«ê¸°(ì´ë²¤íŠ¸ ìœ„ì„: ë²„íŠ¼ì´ ì¬ìƒì„±ë˜ë¯€ë¡œ documentì— ë°”ì¸ë”©)
    document.addEventListener('click', (e) => {
      if (e.target && e.target.id === 'addrClose') {
        addrWrap.style.display = 'none';
        document.body.style.overflow = '';
        addrWrap.innerHTML = '<button id="addrClose" type="button">ë‹«ê¸° âœ•</button>';
      }
    });

    // ===== ì œì¶œ(ê²€ì¦ â†’ API ì „ì†¡) =====
    function val(sel){ return document.querySelector(sel).value.trim(); }
    function ok(sel){  return document.querySelector(sel).checked; }
    function sel(q){   return document.querySelector(q); }

    document.getElementById('btnSubmit').addEventListener('click', async () => {
      // í•„ìˆ˜ê°’ ê²€ì¦
      const requiredChecks = [
        ['#agreeEpi', ok('#agreeEpi')],
        ['#branch', !!val('#branch')],
        ['#agreeRules', ok('#agreeRules')],
        ['#agreePrivacy', ok('#agreePrivacy')],
        ['#agreeNotice', ok('#agreeNotice')],
        ['#childBirth', !!val('#childBirth')],
        ['#childName', !!val('#childName')],
        ['#gender', !!val('#gender')],
        ['#parentName', !!val('#parentName')],
        ['#relation', !!val('#relation')],
        ['#agreePrivacy1', ok('#agreePrivacy1')],
        ['#parentPhone', !!val('#parentPhone')],
        ['#agreePrivacy2', ok('#agreePrivacy2')],
        ['#addrBase', !!val('#addrBase')],
        ['#addrDetail', !!val('#addrDetail')],
        ['#confirmNotice', ok('#confirmNotice')],
      ];
      const fail = requiredChecks.find(([q, pass]) => !pass);
      if (fail) {
        const [q] = fail;
        sel(q).scrollIntoView({behavior:'smooth', block:'center'});
        sel(q).focus();
        alert("í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥/ì²´í¬í•´ì£¼ì„¸ìš”.");
        return;
      }

      // í˜ì´ë¡œë“œ
      const payload = {
        agreeEpi: ok('#agreeEpi'),
        branch: val('#branch'),
        agreeRules: ok('#agreeRules'),
        agreePrivacy: ok('#agreePrivacy'),
        agreeNotice: ok('#agreeNotice'),
        childBirth: val('#childBirth'),
        childName:  val('#childName'),
        gender:     val('#gender'),
        parentName: val('#parentName'),
        relation:   val('#relation'),
        agreePrivacy1: ok('#agreePrivacy1'),
        parentPhone: val('#parentPhone').replace(/\D/g,''), // ìˆ«ìë§Œ ì„œë²„ë¡œ ì „ë‹¬
        agreePrivacy2: ok('#agreePrivacy2'),
        addrBase:   val('#addrBase'),
        addrDetail: val('#addrDetail'),
        confirmNotice: ok('#confirmNotice')
      };

      // ì „ì†¡ UI ì ê¸ˆ
      const btn = document.getElementById('btnSubmit');
      const oldLabel = btn.textContent;
      btn.disabled = true; btn.textContent = 'ì „ì†¡ ì¤‘â€¦';

      try {
        const res = await fetch('/api/apply', {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify(payload),
        });
        const data = await res.json().catch(()=> ({}));
        if (res.ok && data.ok) {
          alert('ì‹ ì²­ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nì ‘ìˆ˜ë²ˆí˜¸: ' + data.id);
          // location.href = '/done';
        } else {
          alert(data.message || `ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (HTTP ${res.status})`);
        }
      } catch(e) {
        alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
      } finally {
        btn.disabled = false; btn.textContent = oldLabel;
      }
    });
  </script>
</body>
</html>
