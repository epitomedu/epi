<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <!-- 캐시 방지 권장 -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <!-- ✅ 시간 가드: 최상단에서 즉시 실행 -->
  <script src="/open.js"></script>

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>신청 폼</title>
  <style>
    :root { color-scheme: light dark; }
    body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; }
    .wrap { max-width:760px; margin:40px auto; padding:0 20px; }
    h2 { font-size:26px; margin:22px 0 14px; }
    .block { margin:18px 0; }
    label { display:block; margin-bottom:8px; font-weight:700; }
    input[type=text], input[type=date], input[type=tel], select {
      width: 360px; max-width: 100%; padding:10px 12px; border:1px solid #cfd4dc; border-radius:6px; font-size:16px;
    }
    input[type=checkbox]{ width:18px; height:18px; vertical-align:middle; }
    .check-row{ margin:8px 0; font-weight:600; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    button { padding:10px 14px; border-radius:8px; border:1px solid #cfd4dc; background:#111827; color:#fff; cursor:pointer; }
    small { color:#6b7280; }

    /* 주소 검색 embed 레이어 */
    #addrWrap {
      display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
      z-index:1000; border:2px solid #333; width:480px; height:520px; background:#fff; box-shadow:0 10px 40px rgba(0,0,0,0.3);
    }
    #addrClose { position:absolute; top:-40px; right:0; background:#333; color:#fff; border:none; padding:6px 12px; cursor:pointer; border-radius:4px; }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Step 1. 지점 -->
    <h2>Step 1. 지점 선택</h2>
    <div class="block">
      <label for="branch">지점</label>
      <select id="branch" required>
        <option value="">선택</option>
        <option>개포</option>
        <option>서초</option>
        <option>압구정</option>
        <option>한남</option>
      </select>
    </div>

    <!-- Step 2. 동의(위) -->
    <h2>Step 2. 동의</h2>
    <div class="block">
      <div class="check-row"><label><input id="agreeRules" type="checkbox" required> 모집 규정을 확인했습니다.</label></div>
      <div class="check-row"><label><input id="agreePrivacy" type="checkbox" required> 개인정보 수집 동의합니다.</label></div>
      <div class="check-row"><label><input id="agreeNotice" type="checkbox" required> 유의 사항을 확인했습니다.</label></div>
    </div>

    <!-- Step 3. 아이/보호자 -->
    <h2>Step 3. 아이/보호자 정보</h2>
    <div class="block">
      <label for="childBirth">아이 생년월일</label>
      <input id="childBirth" type="date" required>
      <small>※ 브라우저의 날짜 선택기를 이용해 선택하세요.</small>
    </div>
    <div class="block">
      <label for="childName">아이 이름</label>
      <input id="childName" type="text" placeholder="이름 입력" required>
    </div>
    <div class="block">
      <label for="gender">성별</label>
      <select id="gender" required>
        <option value="">선택</option>
        <option>남</option>
        <option>여</option>
      </select>
    </div>
    <div class="block">
      <label for="parentName">보호자 성명</label>
      <input id="parentName" type="text" required>
    </div>
    <div class="block">
      <label for="relation">신청 학생과의 관계</label>
      <select id="relation" required>
        <option value="">선택</option>
        <option>모</option>
        <option>부</option>
        <option>기타</option>
      </select>
    </div>
    <div class="block">
      <label for="parentPhone">보호자 휴대폰번호</label>
      <input id="parentPhone" type="tel" inputmode="numeric" pattern="[0-9\-]*" placeholder="01012345678" required>
    </div>

    <!-- Step 4. 주소 -->
    <h2>Step 4. 주소</h2>
    <div class="block">
      <label>주소</label>
      <div class="row">
        <input id="addrBase" type="text" placeholder="기본주소" style="width:420px;" required>
        <button id="btnAddrSearch" type="button">주소 검색</button>
      </div>
      <div class="row" style="margin-top:8px">
        <input id="addrDetail" type="text" placeholder="상세주소 입력" style="width:420px;" required>
      </div>
    </div>

    <!-- Step 5. (하단) 최종 유의사항 확인 -->
    <div class="block">
      <label><input id="confirmNotice" type="checkbox" required> 유의 사항을 최종적으로 확인했습니다.</label>
    </div>

    <!-- 제출 -->
    <div class="block">
      <button id="btnSubmit" type="button">신청하기</button>
    </div>
  </div>

  <!-- 주소검색 embed 레이어 -->
  <div id="addrWrap"><button id="addrClose" type="button">닫기 ✕</button></div>

  <!-- 카카오 우편번호(HTTPS 필수) -->
  <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js" defer></script>
  <script>
    // 주소 검색 embed
    const addrWrap   = document.getElementById('addrWrap');
    const addrBase   = document.getElementById('addrBase');
    const addrDetail = document.getElementById('addrDetail');
    const addrClose  = document.getElementById('addrClose');

    document.getElementById('btnAddrSearch').addEventListener('click', () => {
      addrWrap.style.display = 'block';
      new daum.Postcode({
        oncomplete: function(data) {
          const base = data.roadAddress || data.jibunAddress || "";
          addrBase.value = base;
          addrDetail.focus();
          addrWrap.style.display = 'none';
        },
        onresize: function(size) { addrWrap.style.height = size.height + 'px'; },
        width: '100%',
        height: '100%'
      }).embed(addrWrap);
    });
    addrClose.addEventListener('click', () => { addrWrap.style.display = 'none'; });

    // 제출(필수값 검증 + 미리보기)
    function val(sel){ return document.querySelector(sel).value.trim(); }
    function ok(sel){  return document.querySelector(sel).checked; }
    function sel(sel2){return document.querySelector(sel2);}

    document.getElementById('btnSubmit').addEventListener('click', () => {
      // 간단 검증
      const requiredChecks = [
        ['#branch', !!val('#branch')],
        ['#agreeRules', ok('#agreeRules')],
        ['#agreePrivacy', ok('#agreePrivacy')],
        ['#agreeNotice', ok('#agreeNotice')],
        ['#childBirth', !!val('#childBirth')],
        ['#childName', !!val('#childName')],
        ['#gender', !!val('#gender')],
        ['#parentName', !!val('#parentName')],
        ['#relation', !!val('#relation')],
        ['#parentPhone', !!val('#parentPhone')],
        ['#addrBase', !!val('#addrBase')],
        ['#addrDetail', !!val('#addrDetail')],
        ['#confirmNotice', ok('#confirmNotice')],
      ];
      const fail = requiredChecks.find(([q, pass]) => !pass);
      if (fail) {
        const [q] = fail;
        sel(q).scrollIntoView({behavior:'smooth', block:'center'});
        sel(q).focus();
        alert("필수 항목을 입력/체크해주세요.");
        return;
      }

      const payload = {
        branch: val('#branch'),
        agreeRules: ok('#agreeRules'),
        agreePrivacy: ok('#agreePrivacy'),
        agreeNotice: ok('#agreeNotice'),

        childBirth: val('#childBirth'),
        childName:  val('#childName'),
        gender:     val('#gender'),
        parentName: val('#parentName'),
        relation:   val('#relation'),
        parentPhone: val('#parentPhone').replace(/\D/g,''),

        addrBase:   val('#addrBase'),
        addrDetail: val('#addrDetail'),
        confirmNotice: ok('#confirmNotice')
      };
      alert('제출 미리보기:\n' + JSON.stringify(payload, null, 2));
      // TODO: 실제 제출 엔드포인트가 있으면 fetch(...) 사용
    });
  </script>
</body>
</html>
